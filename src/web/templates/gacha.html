<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeagueSLG: Gacha</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gacha.css') }}">
    <style>
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Navigation -->
        <nav class="main-nav">
            <a href="/" class="active">ğŸ² ì˜ì›… ëª¨ì§‘</a>
            <a href="/map">ğŸ—ºï¸ ì›”ë“œ ë§µ</a>
        </nav>

        <h1>ì‚¼êµ­ ì˜ì›… ëª¨ì§‘</h1>

        <!-- Resources -->
        <div class="resources-panel">
            <div class="resource gold" id="gold-display">
                ğŸ† í™©ê¸ˆ: <span id="gold-count">...</span>
            </div>
            <div class="resource silver" id="silver-display">
                ğŸ¥ˆ ì€ì „: <span id="silver-count">...</span>
            </div>
            <button onclick="mineSilver()"
                style="margin-left: 20px; padding: 5px 10px; cursor: pointer; border-radius: 5px; background: #333; color: white; border: 1px solid var(--gold);">â›ï¸
                ì€ì „ ì±„êµ´ (ë°ëª¨)</button>
        </div>

        <!-- Gacha Cards -->
        <div class="gacha-container">
            <!-- Silver Gacha -->
            <div class="gacha-card silver-card" onclick="pullGacha('silver_gacha')">
                <div class="card-header">
                    <div class="card-title">ë°±ë™ì „ ëª¨ì§‘</div>
                    <div class="card-cost">500 ì€ì „</div>
                </div>
                <div class="card-body">
                    <p>ì¼ë°˜ ì˜ì›… ë° ì¸ë¬¼</p>
                    <button class="btn-pull">ëª¨ì§‘í•˜ê¸°</button>
                </div>
            </div>

            <!-- Gold Gacha -->
            <div class="gacha-card gold-card" onclick="pullGacha('gold_gacha')">
                <div class="card-header">
                    <div class="card-title">í™©ê¸ˆ ì¸ì¥ ëª¨ì§‘</div>
                    <div class="card-cost">100 í™©ê¸ˆ</div>
                </div>
                <div class="card-body">
                    <p>í¬ê·€ / ì „ì„¤ê¸‰ ì˜ì›…</p>
                    <button class="btn-pull">ëª¨ì§‘í•˜ê¸°</button>
                </div>
            </div>

            <!-- Pickup Gacha -->
            <div class="gacha-card pickup-card" onclick="pullGacha('pickup_gacha')">
                <div class="card-header">
                    <div class="card-title">ì‹ ë¼ì˜ ëª…ì¥ í”½ì—…</div>
                    <div class="card-cost">200 í™©ê¸ˆ</div>
                </div>
                <div class="card-body">
                    <p>ì£¼ì—­: <strong>ê¹€ìœ ì‹  & ì¥ë³´ê³ </strong></p>
                    <button class="btn-pull">ëª¨ì§‘í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="result-modal" style="display: none;">
        <div class="modal-content">
            <h2 id="result-title">ì¶•í•˜í•©ë‹ˆë‹¤!</h2>
            <div id="result-content">
                <!-- Dynamic Content -->
            </div>
            <button class="close-btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            updateResources();
        });

        async function updateResources() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                if (data.resources) {
                    document.getElementById('gold-count').innerText = data.resources.gold;
                    document.getElementById('silver-count').innerText = data.resources.silver;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function pullGacha(type) {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            const title = document.getElementById('result-title');

            // Show Loading
            modal.style.display = 'flex';
            title.innerText = "ì˜ì›…ì„ ë¶€ë¥´ëŠ” ì¤‘...";
            content.innerHTML = '<div class="loader"></div>';

            try {
                const response = await fetch('/api/gacha/pull', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gacha_type: type })
                });
                const data = await response.json();

                if (data.success) {
                    title.innerText = "ğŸ‰ ìƒˆë¡œìš´ ì˜ì›…ì˜ í•©ë¥˜!";
                    const heroName = data.result.name;
                    content.innerHTML = `
                    <div style="font-size: 5rem; margin: 20px;">ğŸ›¡ï¸</div>
                    <div class="result-name">${heroName}</div>
                    <p>ë‹¹ì‹ ì˜ ë¶€ëŒ€ì— í•©ë¥˜í–ˆìŠµë‹ˆë‹¤!</p>
                `;
                    // Update resources instantly
                    updateResources();
                } else {
                    title.innerText = "âŒ ëª¨ì§‘ ì‹¤íŒ¨";
                    content.innerHTML = `<p style="color: red;">${data.message}</p>`;
                }

            } catch (e) {
                title.innerText = "Error";
                content.innerHTML = `<p>${e.message}</p>`;
            }
        }

        async function mineSilver() {
            try {
                const response = await fetch('/api/mine/collect', { method: 'POST' });
                const data = await response.json();
                alert(data.message);
                updateResources();
            } catch (e) {
                alert("Mining failed");
            }
        }

        function closeModal() {
            document.getElementById('result-modal').style.display = 'none';
        }

        // Quick close on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('result-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>

</body>

</html>