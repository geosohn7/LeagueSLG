<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeagueSLG: World Map</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
</head>

<body>

    <!-- Navigation -->
    <nav>
        <a href="/">ğŸ² ì˜ì›… ëª¨ì§‘</a>
        <a href="/map" class="active">ğŸ—ºï¸ ì›”ë“œ ë§µ</a>
    </nav>

    <h1>ì‚¼êµ­ ì›”ë“œ ë§µ</h1>

    <div id="map-container">
        <!-- Tiles Generated by JS -->
    </div>

    <div id="info-panel">
        <h3 id="tile-info">íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”...</h3>
        <p id="tile-detail"></p>
        <button id="march-btn"
            style="display: none; margin-top: 10px; padding: 10px 20px; cursor: pointer; border-radius: 5px; background: var(--gold); border: none; font-weight: bold;">ì´ê³³ìœ¼ë¡œ
            í–‰êµ°</button>
    </div>

    <script>
        let selectedTile = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetchMapData();
        });

        async function fetchMapData() {
            try {
                const response = await fetch('/api/map/data');
                const data = await response.json();
                renderMap(data);
            } catch (e) {
                console.error("Map fetch failed", e);
            }
        }

        function renderMap(data) {
            const container = document.getElementById('map-container');
            container.innerHTML = '';

            // Set grid dimensions
            container.style.gridTemplateColumns = `repeat(${data.width}, 50px)`;

            // Render Tiles
            data.tiles.forEach(row => {
                row.forEach(tile => {
                    const tileDiv = document.createElement('div');
                    const resClass = tile.resource ? `res-${tile.resource.toUpperCase()}` : '';
                    tileDiv.className = `tile ${tile.type} ${resClass}`;
                    tileDiv.dataset.x = tile.x;
                    tileDiv.dataset.y = tile.y;

                    // Level Badge
                    const badge = document.createElement('div');
                    badge.className = 'level-badge';
                    badge.innerText = `L${tile.level}`;
                    tileDiv.appendChild(badge);

                    tileDiv.onclick = () => selectTile(tile.x, tile.y, tile, tileDiv);

                    // Content Icons
                    const iconDiv = document.createElement('div');
                    iconDiv.style.zIndex = "2";
                    if (tile.resource) {
                        iconDiv.innerHTML = getResourceIcon(tile.resource);
                    } else if (tile.type === 'castle') {
                        iconDiv.innerHTML = "ğŸ°";
                    } else if (tile.type === 'obstacle') {
                        iconDiv.innerHTML = "â›°ï¸";
                    }
                    tileDiv.appendChild(iconDiv);

                    container.appendChild(tileDiv);
                });
            });

            // Render Armies
            data.armies.forEach(army => {
                const tileIndex = (army.y * data.width) + army.x;
                const tileDiv = container.children[tileIndex];

                if (tileDiv) {
                    const marker = document.createElement('div');
                    marker.className = `army-marker ${army.owner === 'player' ? 'player' : 'enemy'}`;
                    marker.innerText = army.owner === 'player' ? "ğŸ›¡ï¸" : "ğŸ’€";
                    marker.title = army.name;
                    tileDiv.appendChild(marker);
                }
            });
        }

        function getTileClass(category, resource) {
            if (category === 'resource' && resource) return 'resource';
            // Simple mapping based on provided enum values or assumptions
            // assuming category values: 'resource', 'plain', 'mountain', 'water', 'castle'
            const map = {
                'plain': 'grass',
                'resource': 'grass', // Default resource background
                'mountain': 'mountain',
                'water': 'water',
                'castle': 'grass'
            };
            return map[category] || 'grass';
        }

        function getResourceIcon(type) {
            const map = {
                'wood': 'ğŸŒ²',
                'food': 'ğŸŒ¾',
                'iron': 'âš’ï¸',
                'stone': 'ğŸ’',
                'gold': 'ğŸ’°',
                'silver': 'ğŸ¥ˆ'
            };
            return map[type] || '';
        }

        function selectTile(x, y, tile, element) {
            // Remove previous selection
            document.querySelectorAll('.tile.selected').forEach(t => t.classList.remove('selected'));
            element.classList.add('selected');

            selectedTile = { x, y };
            document.getElementById('tile-info').innerText = `ì¢Œí‘œ (${x}, ${y})`;

            let detail = `ì¢…ë¥˜: ${tile.type.toUpperCase()}<br>ë“±ê¸‰: Level ${tile.level}`;
            if (tile.resource) {
                detail += `<br>ìì›: ${tile.resource.toUpperCase()}`;
            }
            document.getElementById('tile-detail').innerHTML = detail;

            const btn = document.getElementById('march-btn');
            btn.style.display = 'inline-block';
            btn.onclick = () => marchTo(x, y);
        }

        async function marchTo(x, y) {
            try {
                const response = await fetch('/api/map/march', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x, y })
                });
                const res = await response.json();

                if (res.success) {
                    alert(res.message);
                    fetchMapData(); // Refresh map
                } else {
                    alert("Move Failed: " + res.message);
                }
            } catch (e) {
                alert("Error moving army");
            }
        }
    </script>

</body>

</html>